// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id              Int              @id @default(autoincrement())
  name            String           @db.VarChar(255)
  code            Int              @unique // كود العميل الفريد
  phone           String?          @db.VarChar(20)
  address         String?          @db.Text
  invoices        SalesInvoice[]
  receiptVouchers ReceiptVoucher[]
  salesReturns    SalesReturn[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model Supplier {
  id              Int               @id @default(autoincrement())
  name            String            @db.VarChar(255)
  code            Int               @unique
  phone           String?           @db.VarChar(20)
  address         String?           @db.Text
  category        String?           @db.VarChar(100)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  invoices        PurchaseInvoice[]
  paymentVouchers PaymentVoucher[]
  purchaseReturns PurchaseReturn[]
}

model SalesInvoice {
  id            Int                @id @default(autoincrement())
  invoiceNumber Int                @unique
  customerName  String             @db.VarChar(255)
  customerId    Int
  customer      Customer           @relation(fields: [customerId], references: [id])
  invoiceDate   DateTime
  subtotal      Float
  totalTax      Float
  discount      Float              @default(0)
  total         Float
  status        InvoiceStatus      @default(cash)
  description   String?
  topNotes      Json?
  notes         Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  items         SalesInvoiceItem[]
  salesReturns  SalesReturn[]
}

model SalesInvoiceItem {
  id          Int          @id @default(autoincrement())
  invoice     SalesInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId   Int
  description String       @db.VarChar(255)
  quantity    Float
  unitPrice   Float
  taxRate     Float        @default(0)
  discount    Float        @default(0)
  total       Float
  productId   Int?
  product     Product?     @relation(fields: [productId], references: [id])
}

model PurchaseInvoice {
  id              Int                   @id @default(autoincrement())
  invoiceNumber   Int                   @unique
  supplierName    String                @db.VarChar(255)
  supplierId      Int
  supplier        Supplier              @relation(fields: [supplierId], references: [id])
  invoiceDate     DateTime
  subtotal        Float
  totalTax        Float
  discount        Float                 @default(0)
  total           Float
  status          InvoiceStatus         @default(cash)
  description     String?
  topNotes        Json?
  notes           Json?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  items           PurchaseInvoiceItem[]
  purchaseReturns PurchaseReturn[]
}

model PurchaseInvoiceItem {
  id          Int             @id @default(autoincrement())
  invoice     PurchaseInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId   Int
  description String          @db.VarChar(255)
  quantity    Float
  unitPrice     Float
  sellingPrice  Float           @default(0)
  profitMargin  Float           @default(0)
  taxRate       Float           @default(0)
  discount      Float           @default(0)
  total         Float
  productId     Int?
  product       Product?        @relation(fields: [productId], references: [id])
}

enum InvoiceStatus {
  cash
  credit
  pending
}

// ========== الخزائن ==========
model TreasurySafe {
  id              Int              @id @default(autoincrement())
  name            String           @db.VarChar(255)
  balance         Float            @default(0)
  description     String?          @db.Text
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  salesReturns    SalesReturn[] // مرتجعات مبيعات تم ردها إلى هذه الخزنة
  purchaseReturns PurchaseReturn[] // مرتجعات مشتريات تم سحبها من هذه الخزنة
  receiptVouchers ReceiptVoucher[]
  paymentVouchers PaymentVoucher[]
}

// ========== البنوك ==========
model TreasuryBank {
  id              Int              @id @default(autoincrement())
  name            String           @db.VarChar(255)
  accountNumber   String?          @db.VarChar(100)
  branch          String?          @db.VarChar(255)
  balance         Float            @default(0)
  description     String?          @db.Text
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  salesReturns    SalesReturn[] // مرتجعات مبيعات تم ردها إلى هذا البنك
  purchaseReturns PurchaseReturn[] // مرتجعات مشتريات تم سحبها من هذا البنك
  receiptVouchers ReceiptVoucher[]
  paymentVouchers PaymentVoucher[]
}

// ========== سندات القبض ==========
model ReceiptVoucher {
  id              Int              @id @default(autoincrement())
  voucherNumber   String           @unique @db.VarChar(50)
  date            DateTime
  amount          Float
  description     String?          @db.Text
  purchaseReturns PurchaseReturn[] // سندات القبض المرتبطة بمرتجعات المشتريات
  // من العميل
  customerId      Int
  customer        Customer         @relation(fields: [customerId], references: [id])

  // إلى خزنة أو بنك
  accountType String        @db.VarChar(10) // "safe" or "bank"
  safeId      Int?
  safe        TreasurySafe? @relation(fields: [safeId], references: [id])
  bankId      Int?
  bank        TreasuryBank? @relation(fields: [bankId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([safeId])
  @@index([bankId])
}

// ========== سندات الصرف ==========
model PaymentVoucher {
  id            Int           @id @default(autoincrement())
  voucherNumber String        @unique @db.VarChar(50)
  date          DateTime
  amount        Float
  description   String?       @db.Text
  salesReturns  SalesReturn[] // سندات الصرف المرتبطة بمرتجعات المبيعات
  // من خزنة أو بنك
  accountType   String        @db.VarChar(10) // "safe" or "bank"
  safeId        Int?
  safe          TreasurySafe? @relation(fields: [safeId], references: [id])
  bankId        Int?
  bank          TreasuryBank? @relation(fields: [bankId], references: [id])

  // إلى المورد
  supplierId Int
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supplierId])
  @@index([safeId])
  @@index([bankId])
}

// ========== مرتجعات المبيعات ==========
model SalesReturn {
  id           Int           @id @default(autoincrement())
  returnNumber Int           @unique
  invoiceId    Int // الفاتورة الأصلية
  invoice      SalesInvoice  @relation(fields: [invoiceId], references: [id])
  customerId   Int
  customer     Customer      @relation(fields: [customerId], references: [id])
  returnDate   DateTime
  subtotal     Float // إجمالي قبل الخصم/الضريبة
  discount     Float         @default(0)
  totalTax     Float         @default(0)
  total        Float // الإجمالي النهائي
  reason       String? // سبب الإرجاع
  status       ReturnStatus  @default(pending) // pending, completed, rejected
  // طريقة الرد: إما نقدي أو إلى الخزنة/البنك
  refundMethod RefundMethod  @default(cash) // cash, bank, safe
  safeId       Int?
  safe         TreasurySafe? @relation(fields: [safeId], references: [id])
  bankId       Int?
  bank         TreasuryBank? @relation(fields: [bankId], references: [id])
  description  String? // ملاحظات إضافية
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  items           SalesReturnItem[]
  // سندات الصرف المرتبطة (إذا تم رد المبلغ)
  paymentVouchers PaymentVoucher[] // يمكن ربطها بسندات صرف

  @@index([invoiceId])
  @@index([customerId])
  @@index([returnDate])
}

model SalesReturnItem {
  id            Int         @id @default(autoincrement())
  returnId      Int
  return        SalesReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  invoiceItemId Int? // لو أردنا ربط بند معين في الفاتورة الأصلية
  description   String      @db.VarChar(255)
  quantity      Float
  unitPrice     Float
  taxRate       Float       @default(0)
  total         Float
}

// ========== مرتجعات المشتريات ==========
model PurchaseReturn {
  id           Int             @id @default(autoincrement())
  returnNumber Int             @unique
  invoiceId    Int // فاتورة الشراء الأصلية
  invoice      PurchaseInvoice @relation(fields: [invoiceId], references: [id])
  supplierId   Int
  supplier     Supplier        @relation(fields: [supplierId], references: [id])
  returnDate   DateTime
  subtotal     Float
  discount     Float           @default(0)
  totalTax     Float           @default(0)
  total        Float
  reason       String?
  status       ReturnStatus    @default(pending)
  // طريقة الاسترداد: نقدي أو إلى الخزنة/البنك
  refundMethod RefundMethod    @default(cash)
  safeId       Int?
  safe         TreasurySafe?   @relation(fields: [safeId], references: [id])
  bankId       Int?
  bank         TreasuryBank?   @relation(fields: [bankId], references: [id])
  description  String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  items           PurchaseReturnItem[]
  receiptVouchers ReceiptVoucher[] // سندات قبض (إذا استرداد نقدي)

  @@index([invoiceId])
  @@index([supplierId])
  @@index([returnDate])
}

model PurchaseReturnItem {
  id            Int            @id @default(autoincrement())
  returnId      Int
  return        PurchaseReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  invoiceItemId Int?
  description   String         @db.VarChar(255)
  quantity      Float
  unitPrice     Float
  taxRate       Float          @default(0)
  total         Float
}

enum ReturnStatus {
  pending
  completed
  rejected
}

enum RefundMethod {
  cash
  safe
  bank
}

// ========== المخزون ==========

enum MovementType {
  PURCHASE
  SALE
  PURCHASE_RETURN
  SALE_RETURN
  ADJUSTMENT
}

model Category {
  id        Int       @id @default(autoincrement())
  name      String    @db.VarChar(100)
  code      String?   @unique @db.VarChar(50)
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Warehouse {
  id             Int             @id @default(autoincrement())
  name           String          @db.VarChar(100)
  location       String?         @db.VarChar(255)
  isDefault      Boolean         @default(false)
  stockMovements StockMovement[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Product {
  id                   Int                   @id @default(autoincrement())
  code                 String                @unique @db.VarChar(50)
  name                 String                @db.VarChar(255)
  unit                 String?               @db.VarChar(50)
  buyPrice             Float                 @default(0)
  sellPrice            Float                 @default(0)
  profitMargin         Float                 @default(0)
  minStock             Float                 @default(0)
  currentStock         Float                 @default(0)
  isActive             Boolean               @default(true)
  categoryId           Int?
  category             Category?             @relation(fields: [categoryId], references: [id])
  stockMovements       StockMovement[]
  salesInvoiceItems    SalesInvoiceItem[]
  purchaseInvoiceItems PurchaseInvoiceItem[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
}

model StockMovement {
  id                Int          @id @default(autoincrement())
  productId         Int
  product           Product      @relation(fields: [productId], references: [id])
  movementType      MovementType
  quantity          Float
  unitPrice         Float        @default(0)
  reference         String?      @db.VarChar(100)
  notes             String?      @db.Text
  warehouseId       Int?
  warehouse         Warehouse?   @relation(fields: [warehouseId], references: [id])
  purchaseInvoiceId Int?
  salesInvoiceId    Int?
  purchaseReturnId  Int?
  salesReturnId     Int?
  createdAt         DateTime     @default(now())

  @@index([productId])
  @@index([movementType])
  @@index([createdAt])
  @@index([warehouseId])
}
